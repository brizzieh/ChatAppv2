{% extends "layouts/_base.html" %}
{% block title %}Your Contacts{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6">
    <!-- Main Container -->
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <!-- Header -->
        <div class="p-8 border-b border-gray-200">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        Your Contacts
                    </h1>
                    <p class="text-gray-600 mt-2">Manage your professional network</p>
                </div>
                
                <!-- Add Contact Button -->
                <button onclick="openModal()" 
                        class="flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg transition-all duration-300 shadow hover:shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                    </svg>
                    <span>Add Contact</span>
                </button>
            </div>
        </div>

        <!-- Pending Requests Section -->
        {% if pending_requests %}
        <div class="p-6 border-b border-gray-200 bg-blue-50">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Pending Requests</h2>
            <div class="space-y-3">
                {% for request in pending_requests %}
                <div class="flex items-center justify-between bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex items-center space-x-3">
                        <img src="https://ui-avatars.com/api/?name={{ request.requester.get_full_name|default:request.requester.username }}&background=random&color=fff&size=64"
                             class="w-10 h-10 rounded-full">
                        <div>
                            <h3 class="font-medium">{{ request.requester.get_full_name|default:request.requester.username }}</h3>
                            <p class="text-sm text-gray-500">Sent {{ request.created_at|timesince }} ago</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="respondToRequest({{ request.id }}, 'accept')" 
                                class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm flex items-center transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Accept
                        </button>
                        <button onclick="respondToRequest({{ request.id }}, 'reject')" 
                                class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm flex items-center transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Reject
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Sent Requests Section -->
        {% if sent_requests %}
        <div class="p-6 border-b border-gray-200 bg-yellow-50">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Sent Requests</h2>
            <div class="space-y-3">
                {% for request in sent_requests %}
                <div class="flex items-center justify-between bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex items-center space-x-3">
                        <img src="https://ui-avatars.com/api/?name={{ request.recipient.get_full_name|default:request.recipient.username }}&background=random&color=fff&size=64"
                             class="w-10 h-10 rounded-full">
                        <div>
                            <h3 class="font-medium">{{ request.recipient.get_full_name|default:request.recipient.username }}</h3>
                            <p class="text-sm text-gray-500">Sent {{ request.created_at|timesince }} ago</p>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Pending</span>
                        </div>
                    </div>
                    <button onclick="cancelRequest({{ request.id }})" 
                            class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm transition">
                        Cancel
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Search Bar -->
        <div class="p-6 border-b border-gray-200">
            <div class="relative max-w-md">
                <input type="text" id="contact-search" placeholder="Search contacts..." 
                       class="w-full bg-gray-100 border-0 focus:ring-2 focus:ring-blue-500 focus:bg-white rounded-full py-2 px-4 pl-10 text-gray-700 focus:outline-none focus:shadow-md transition">
                <div class="absolute left-3 top-2.5 text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Contact Grid -->
        <div class="p-6">
            <div id="contacts-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {% for user in contact_users %}
                <div class="group bg-white border border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1 relative overflow-hidden">
                    <!-- Gradient background overlay -->
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-50/20 to-purple-50/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    
                    <!-- Accessible Delete Button -->
                    <button onclick="removeContact({{ user.id }})" 
                            class="absolute top-4 right-4 p-2 bg-white rounded-full hover:bg-red-50 transition-all z-99 group/delete"
                            aria-label="Remove contact">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500 group-hover/delete:text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span class="sr-only">Remove contact</span>
                    </button>
                    
                    <div class="relative z-10">
                        <div class="flex flex-col items-center text-center">
                            <div class="relative mb-4">
                                <img src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ user.get_full_name|default:user.username }}&background=random&color=fff&size=128{% endif %}" 
                                    alt="{{ user.username }}"
                                    class="w-20 h-20 rounded-full object-cover border-4 border-white shadow-md">
                                <span class="absolute bottom-0 right-0 block h-4 w-4 rounded-full bg-green-400 ring-2 ring-white"></span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">
                                    {{ user.get_full_name|default:user.username }}
                                </h3>
                                <p class="text-gray-600 text-sm mt-1">{{ user.email }}</p>
                                <div class="mt-3 flex justify-center space-x-2">
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2.5 py-1 rounded-full">Contact</span>
                                    {% if user.is_staff %}
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2.5 py-1 rounded-full">Staff</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-16">
                    <div class="mx-auto w-24 h-24 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-medium text-gray-700">No contacts yet</h3>
                    <p class="text-gray-500 mt-2">Start by adding your first contact</p>
                    <button onclick="openModal()" class="mt-6 px-6 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg transition shadow-md">
                        Add First Contact
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

<!-- Add Contact Modal -->
<div id="add-contact-modal" class="fixed inset-0 bg-black/50 z-999 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">Add New Contact</h3>
            <p class="text-gray-500 text-sm mt-1">Select a user to connect with</p>
        </div>
        
        <div class="p-6">
            <form id="add-contact-form" method="post">
                {% csrf_token %}
                <div class="mb-6">
                    <div class="relative mb-4">
                        <input type="text" id="user-search" placeholder="Filter users..." 
                               class="w-full bg-gray-100 border-0 focus:ring-2 focus:ring-blue-500 focus:bg-white rounded-full py-2 px-4 pl-10 text-gray-700 focus:outline-none focus:shadow-md transition"
                               oninput="filterUsers()">
                        <div class="absolute left-3 top-2.5 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Selected User Confirmation -->
                    <div id="selected-user-confirmation" class="hidden mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img id="selected-user-avatar" src="" class="w-10 h-10 rounded-full mr-3">
                                <div>
                                    <div id="selected-user-name" class="font-medium text-gray-800"></div>
                                    <div id="selected-user-email" class="text-sm text-gray-600"></div>
                                </div>
                            </div>
                            <button type="button" onclick="clearSelection()" class="text-gray-400 hover:text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <input type="hidden" name="contact_id" id="selected-user-id" value="">
                    </div>
                    
                    <!-- User List (hidden when user is selected) -->
                    <div id="user-list-container">
                        <div id="user-list" class="max-h-96 overflow-y-auto space-y-2 border border-gray-200 rounded-lg p-2">
                            {% for user in all_users %}
                                {% if user.id not in contact_user_ids %}
                                <div class="user-item flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition"
                                     data-user-id="{{ user.id }}"
                                     onclick="selectUser(this, '{{ user.get_full_name|default:user.username }}', '{{ user.email }}')">
                                    <img src="https://ui-avatars.com/api/?name={{ user.get_full_name|default:user.username }}&background=random&color=fff&size=64"
                                         class="w-10 h-10 rounded-full mr-3">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-800 truncate">{{ user.get_full_name|default:user.username }}</div>
                                        <div class="text-sm text-gray-500 truncate">{{ user.email }}</div>
                                    </div>
                                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        <p id="no-users-message" class="text-center text-gray-500 py-4 hidden">
                            No users available to add
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                            class="px-5 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition">
                        Cancel
                    </button>
                    <button type="submit" id="submit-btn" disabled
                            class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>Send Request</span>
                        <svg id="submit-spinner" class="hidden h-5 w-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

</div>

<script>
// Modal Functions
function openModal() {
    const modal = document.getElementById('add-contact-modal');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    modal.classList.add('opacity-100');
    document.getElementById('user-search').focus();
}

function closeModal() {
    const modal = document.getElementById('add-contact-modal');
    modal.classList.remove('opacity-100');
    modal.classList.add('opacity-0', 'pointer-events-none');
    clearSelection();
}

// Filter users as you type
function selectUser(element, name, email) {
    const confirmationSection = document.getElementById('selected-user-confirmation');
    const userListContainer = document.getElementById('user-list-container');
    const selectedUserId = element.getAttribute('data-user-id');
    
    // Update confirmation section
    document.getElementById('selected-user-id').value = selectedUserId;
    document.getElementById('selected-user-name').textContent = name;
    document.getElementById('selected-user-email').textContent = email;
    document.getElementById('selected-user-avatar').src = `https://ui-avatars.com/api/?name=${name}&background=random&color=fff&size=64`;
    
    // Show confirmation, hide user list
    confirmationSection.classList.remove('hidden');
    userListContainer.classList.add('hidden');
    
    // Enable submit button
    document.getElementById('submit-btn').disabled = false;
}

function clearSelection() {
    const confirmationSection = document.getElementById('selected-user-confirmation');
    const userListContainer = document.getElementById('user-list-container');
    
    // Clear selection
    document.getElementById('selected-user-id').value = '';
    document.getElementById('user-search').value = '';
    
    // Show user list, hide confirmation
    confirmationSection.classList.add('hidden');
    userListContainer.classList.remove('hidden');
    
    // Disable submit button
    document.getElementById('submit-btn').disabled = true;
    
    // Reset filter
    filterUsers();
}

function filterUsers() {
    const searchTerm = document.getElementById('user-search').value.toLowerCase();
    const userItems = document.querySelectorAll('#user-list .user-item');
    let visibleCount = 0;
    
    userItems.forEach(user => {
        const name = user.querySelector('.font-medium').textContent.toLowerCase();
        const email = user.querySelector('.text-sm').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || email.includes(searchTerm)) {
            user.style.display = 'flex';
            visibleCount++;
        } else {
            user.style.display = 'none';
        }
    });
    
    // Show/hide no users message
    const noUsersMessage = document.getElementById('no-users-message');
    if (visibleCount === 0) {
        noUsersMessage.classList.remove('hidden');
    } else {
        noUsersMessage.classList.add('hidden');
    }
}

// AJAX Form Submission
document.getElementById('add-contact-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const spinner = form.querySelector('#submit-spinner');
    
    // Show loading state
    submitBtn.disabled = true;
    spinner.classList.remove('hidden');
    
    // Get form data
    const formData = new FormData(form);
    const contactId = formData.get('contact_id');
    
    if (!contactId) {
        alert('Please select a user to add');
        submitBtn.disabled = false;
        spinner.classList.add('hidden');
        return;
    }
    
    // Send AJAX request
    fetch("{% url 'add_contact' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: JSON.stringify({ contact_id: contactId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, data.status);
            closeModal();
            form.reset();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, data.status);
        }
    })
    .catch(error => {
        showNotification('An error occurred', 'error');
        console.error('Error:', error);
    })
    .finally(() => {
        submitBtn.disabled = false;
        spinner.classList.add('hidden');
    });
});

// Respond to Request
function respondToRequest(requestId, action) {
    fetch("{% url 'respond_to_request' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            request_id: requestId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(data.message, data.status);
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('An error occurred', 'error');
        console.error('Error:', error);
    });
}

// Cancel Request
function cancelRequest(requestId) {
    if (confirm('Are you sure you want to cancel this request?')) {
        respondToRequest(requestId, 'reject');
    }
}

// Remove Contact
function removeContact(userId) {
    if (confirm('Are you sure you want to remove this contact?')) {
        fetch("{% url 'remove_contact' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification(data.message, data.status);
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message, 'error');
            }
        });
    }
}

// Search Functionality
document.getElementById('contact-search').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const cards = document.querySelectorAll('#contacts-container > div:not(.col-span-full)');
    
    cards.forEach(card => {
        const name = card.querySelector('h3').textContent.toLowerCase();
        const email = card.querySelector('p.text-gray-600').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || email.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});

// Notification Function
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-6 right-6 px-6 py-3 rounded-lg shadow-lg border ${
        type === 'success' ? 'bg-green-100 border-green-300 text-green-800' :
        type === 'error' ? 'bg-red-100 border-red-300 text-red-800' :
        'bg-blue-100 border-blue-300 text-blue-800'
    } transition-all transform translate-x-64`;
    notification.innerHTML = `
        <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${
                    type === 'success' ? 'M5 13l4 4L19 7' :
                    type === 'error' ? 'M6 18L18 6M6 6l12 12' :
                    'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
                }" />
            </svg>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-64');
    }, 10);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-x-64');
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}
</script>
{% endblock %}